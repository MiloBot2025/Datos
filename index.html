<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Listas y Reportes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#121822; --ink:#e6edf3; --muted:#9fb0c3; --acc:#6aa9ff; --ok:#00c853; --warn:#ffab00; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial;}
    a{color:var(--acc);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
    header h1{font-size:22px;margin:0}
    .card{background:var(--panel);border:1px solid #1e2530;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    h2{font-size:18px;margin:0 0 10px}
    ul{list-style:none;margin:0;padding:0}
    li{padding:8px 0;border-bottom:1px solid #232c38}
    li:last-child{border-bottom:0}
    .meta{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .ok{background:#00391e;color:#7dffb2;border:1px solid #0b5}
    .no{background:#3a1111;color:#ffb2b2;border:1px solid #a33}
    .warn{background:#2a220f;color:#ffd27d;border:1px solid #aa7}
    footer{color:var(--muted);font-size:12px;margin:18px 0 40px}
    code{background:#0f1420;border:1px solid #1d2532;padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Listas y Reportes</h1>
      <span class="pill ok" id="onlinePill">online</span>
    </header>

    <div class="meta">Última actualización render: <span id="lastUpdate"></span></div>

    <div class="card" id="bases">
      <h2>Bases (copia exacta)</h2>
      <ul id="basesList"><li class="meta">Cargando…</li></ul>
    </div>

    <div class="card" id="listas">
      <h2>Últimas “Hoja 1”</h2>
      <ul id="listasList"><li class="meta">Cargando…</li></ul>
    </div>

    <div class="card" id="reportes">
      <h2>Reportes de cambios</h2>
      <ul id="reportsList"><li class="meta">Cargando…</li></ul>
    </div>

    <footer>
      Si algo no se ve, probá refrescar fuerte (Ctrl/Cmd + F5). Esta página usa <code>?ts=cache-busting</code> para forzar el CDN.
    </footer>
  </div>

<script>
(function(){
  const TS = Date.now();
  const bust = (u) => u + (u.includes('?') ? '&' : '?') + 'ts=' + TS;

  document.getElementById('lastUpdate').textContent = new Date(TS).toISOString();

  // Fuentes y nombres esperados (con fallback al viejo nombre de IMSA)
  const FUENTES = {
    Tevelam:   { listaNames: ["Tevelam_ULTIMA.xlsx"],    dbName: "Tevelam_DB.xlsx" },
    Disco_Pro: { listaNames: ["Disco_Pro_ULTIMA.xlsx"],  dbName: "Disco_Pro_DB.xlsx" },
    ARS_Tech:  { listaNames: ["ARS_Tech_ULTIMA.xlsx"],   dbName: "ARS_Tech_DB.xlsx" },
    IMSA:      { listaNames: ["IMSA_ULTIMA.xlsx","ListaImsa_ULTIMA.xlsx"], dbName: "IMSA_DB.xlsx" }
  };

  async function urlExists(url){
    try {
      const res = await fetch(url, { method: "HEAD", cache: "no-store" });
      return res.ok;
    } catch { return false; }
  }

  async function findFirstExisting(basePath, names){
    for (const n of names){
      const u = basePath + "/" + n;
      if (await urlExists(u)) return bust(u);
      // probar también con cache-busting por si el CDN tiene versión vieja
      if (await urlExists(bust(u))) return bust(u);
    }
    return null;
  }

  async function renderBases(){
    const ul = document.getElementById('basesList');
    ul.innerHTML = "";
    for (const key of Object.keys(FUENTES)){
      const dbPath = "public_db/" + FUENTES[key].dbName;
      const metaPath = "public_db/" + FUENTES[key].dbName.replace(/\.xlsx$/,".meta.json");
      const exists = await urlExists(bust(dbPath));
      const li = document.createElement('li');
      if (exists){
        let metaTxt = "";
        try{
          const r = await fetch(bust(metaPath), {cache:"no-store"});
          if (r.ok){
            const meta = await r.json();
            metaTxt = ` — sha256: <code>${(meta.sha256||"").slice(0,12)}…</code> — guardado AR: ${meta.saved_at_ar||"?"}`;
          }
        }catch{}
        li.innerHTML = `• <a href="${bust(dbPath)}" download>${FUENTES[key].dbName}</a><span class="pill ok">disponible</span> <span class="meta">${metaTxt}</span>`;
      } else {
        li.innerHTML = `• ${FUENTES[key].dbName} <span class="pill no">no encontrado</span>`;
      }
      ul.appendChild(li);
    }
  }

  async function renderListas(){
    const ul = document.getElementById('listasList');
    ul.innerHTML = "";
    for (const key of Object.keys(FUENTES)){
      const url = await findFirstExisting("public_listas", FUENTES[key].listaNames);
      const li = document.createElement('li');
      if (url){
        const nameShown = decodeURIComponent(url.split("/").pop().split("?")[0]);
        li.innerHTML = `• <a href="${url}" download>${nameShown}</a> <span class="pill ok">disponible</span>`;
      } else {
        li.innerHTML = `• ${FUENTES[key].listaNames[0]} <span class="pill no">no encontrado</span>`;
      }
      ul.appendChild(li);
    }
  }

  async function renderReportes(){
    const ul = document.getElementById('reportsList');
    ul.innerHTML = "";
    try{
      const r = await fetch(bust("public_reports/index.json"), {cache:"no-store"});
      if (!r.ok) throw new Error("index.json no disponible");
      const data = await r.json();
      // se espera un array de objetos: { name, size_kb, url }
      (data || []).forEach(item => {
        const li = document.createElement('li');
        const link = bust(item.url || ("public_reports/" + item.name));
        li.innerHTML = `• <a href="${link}" download>${item.name}</a> <span class="meta">— ${item.size_kb||""} KB</span>`;
        ul.appendChild(li);
      });
      if (!ul.children.length){
        ul.innerHTML = '<li class="meta">No hay reportes generados todavía.</li>';
      }
    }catch(e){
      ul.innerHTML = '<li class="meta">No se pudo leer <code>public_reports/index.json</code>.</li>';
    }
  }

  (async function run(){
    await Promise.all([renderBases(), renderListas(), renderReportes()]);
  })();

})();
</script>
</body>
</html>
